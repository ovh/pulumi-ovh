name: Test Maven central credentials

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  ossrh-auth-check:
    runs-on: ubuntu-latest

    steps:
      - name: Sanity check secrets presence
        run: |
          if [ -z "$OSSRH_USERNAME" ] || [ -z "$OSSRH_PASSWORD" ]; then
            echo "âŒ OSSRH credentials not injected"
            exit 1
          fi
          echo "âœ… OSSRH credentials injected"
        env:
          OSSRH_USERNAME: ${{ vars.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          
      - name: Prepare workspace
        run: |
          mkdir creds-test && cd creds-test
        shell: bash

      - name: Install GPG
        run: sudo apt-get update && sudo apt-get install -y gnupg

      - name: Import GPG key
        run: |
          echo "$SIGNING_KEY" | base64 --decode | gpg --batch --import
        env:
          SIGNING_KEY: ${{ secrets.JAVA_SIGNING_KEY }}

      - name: Test GPG signing
        run: |
          echo "ðŸ”¹ Testing GPG signing..."
          echo "test" > creds-test/test.txt
          gpg --batch --yes \
            --pinentry-mode loopback \
            --passphrase "$SIGNING_PASSWORD" \
            --local-user "$SIGNING_KEY_ID" \
            --output creds-test/test.txt.sig \
            --detach-sign creds-test/test.txt && echo "âœ… GPG key valid"
        env:
          SIGNING_PASSWORD: ${{ secrets.JAVA_SIGNING_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.JAVA_SIGNING_KEY_ID }}

      - name: Test Maven / OSSRH credentials
        run: |
          echo "ðŸ”¹ Testing Maven / OSSRH credentials..."
          mvn -B -DskipTests -Dgpg.skip=true deploy && echo "âœ… OSSRH credentials valid"
        env:
          OSSRH_USERNAME: ${{ vars.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          GPG_KEYNAME: ${{ secrets.JAVA_SIGNING_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.JAVA_SIGNING_PASSWORD }}

